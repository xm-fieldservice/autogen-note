

我将修复两个可能导致“必填项不显示”的根因：
1) 读取必填项初始值时，仅从 model_client.config 读取；若配置文件把字段放在顶层 config，会导致显示为空。改为读取时优先 model_client.config，回退顶层 config。
2) 中间栏滚动容器的宿主 widget 没有显式 setLayout（仅把 QFormLayout 传了 parent），在某些环境下会导致布局未生效。我将补上 host.setLayout(self._model_param_form)。

现在我会对 [app/ui/main_window.py](cci:7://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:0:0-0:0) 进行精确补丁。



# 结论先说
基于目前代码最新实现，三个基本参数（`model` / `base_url` / `api_key_env`）已经被放到了中间栏参数表单的最顶部三行，和其它参数使用完全一致的样式、同一套构建与写回逻辑。因此：
- 如果右侧“配置文件预览”里就没有这三个字段，那是“解析路径不对或配置文件本身没有这些字段”（解析问题）。
- 如果右侧预览里有三个字段，但中间栏顶部仍未出现三行，那是“UI 构建/布局显示问题”（显示问题）。

下面给出快速判别与我们刚做的改动点。

# 我刚做了什么（与你的问题相关）
- 在 [app/ui/main_window.py](cci:7://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:0:0-0:0) 的 [MainWindow._refresh_model_param_panel()](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:1794:4-2261:20)：
  - 顶部先添加三行必填项输入框（`QLineEdit`），标签分别为：
    - `模型ID (model)`
    - `Base URL`
    - `API Key 环境变量名`
  - 这三行的初始值读取策略与其它参数一致，明确了“优先 `model_client.config`，回退顶层 `config`”：
    - 读取使用 [_cfg_get(key)](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:1819:12-1821:77)，依次尝试：`model_client.config.<key>` → 顶层 `config.<key>`。
  - 三行的写回路径固定在 `model_client.config.<key>`，并在回写后调用 [_update_model_config_preview()](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:2573:4-2602:20)，与其它参数保持同样的“编辑即写回、右侧预览即时刷新的交互反馈”。
  - 遍历其他字段时跳过这三项，避免重复。
- 在 [_create_model_middle_panel()](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:1727:4-1783:20)：
  - 修复了滚动容器宿主的布局设置问题：`QFormLayout(host)` 后显式 `host.setLayout(self._model_param_form)`，防止个别环境下布局未生效导致首部行不显示。
- 为了便于你判断显示链路是否走通，我加了两处日志：
  - 表单添加完三行后打印一条：
    - `[ModelUI] 已添加必填项行：model/base_url/api_key_env`
  - 整个参数表单构建完成后打印表单当前行数：
    - `[ModelUI] 参数表单构建完成，当前行数: <N>`

# 快速判别步骤（帮你判断“解析”还是“显示”）
1) 在 Model 页载入你的模型 JSON（左侧“路径 + 浏览/回车”，或使用模型下拉）后，看右侧“配置文件预览”：
   - 如果预览里“没有”`model`/`base_url`/`api_key_env`，那是“解析问题”（配置路径不符合我们读取的两条路径，或文件确实没这几项）。
   - 如果预览里“有值”，但中间栏顶部三行看不到，那是“显示问题”（布局/刷新没生效）。
2) 查看日志（控制台或 [logs/app.log](cci:7://file:///d:/AI-Projects/desktop_app/logs/app.log:0:0-0:0)）是否有：
   - `[ModelUI] 已添加必填项行：model/base_url/api_key_env`
   - `[ModelUI] 参数表单构建完成，当前行数: ...`
   - 如果看到了这两行，说明 UI 构建链路已经执行，中间栏表单有生成。此时若仍看不到三行，多数是“滚动区域未滚到顶部/容器约束”等显示层面问题。
3) 再次编辑任意一行（比如改 `model`），右侧预览是否即时变化：
   - 如果能变，说明 UI 绑定与写回逻辑正常。
   - 如果不变，说明 UI 绑定或 [_update_model_config_preview()](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:2573:4-2602:20) 没触发，需要针对性继续查。

# 常见“解析问题”的根因
- 你的模型文件把字段放到了非预期路径（我们支持以下两种）：
  - `model_client.config.model|base_url|api_key_env`（首选）
  - 顶层 `config.model|base_url|api_key_env`（回退）
- 如果你的 JSON 用了其他自定义字段名或层级（比如放在 `provider` 下、或改名为 `api_key` 等），那么中间栏必填项“初始值显示”会是空（因为没解析出来），但输入框仍然会显示。你一旦填入值，就会写回到标准路径 `model_client.config.<key>` 并体现在右侧预览。

# 常见“显示问题”的根因
- 首次打开时没有滚到中间栏顶端。中间栏是 `QScrollArea` 包裹的 `QFormLayout`，若窗口高度较小，必须滚动到顶部才能看到三行。
- 表单布局未生效。已经通过 `host.setLayout(self._model_param_form)` 加固；你可以留意日志里的 `[ModelUI]` 两条检查是否进入构建逻辑。
- 某些异常被吞掉导致中断。我们周围都有 try/except 防御，不至于崩溃，但会在日志里看到 warning。

# 下一步建议
- 请用一个具体的模型 JSON 路径测试，并告诉我：
  - 右侧“配置文件预览”中，是否能看到 `model`/`base_url`/`api_key_env` 的值？
  - 日志中是否出现了 `[ModelUI] 已添加必填项行...` 与 “行数”那条日志？
- 如果预览里就没有这三项，请把该 JSON 的相关结构粘出来（至少 `model_client` 与 `config` 两层），我会按你的结构补上兼容解析（保持“优先内生规范”的路径，仍落入 `model_client.config`）。
- 如果预览里有这三项但 UI 还不显示，我将继续在 [_create_model_middle_panel()](cci:1://file:///d:/AI-Projects/desktop_app/app/ui/main_window.py:1727:4-1783:20) 的布局与伸缩策略上做一次紧凑性调整（比如去掉 `SetMinAndMaxSize` 约束、收紧外边距、强制 `scroll.ensureVisible`），确保首部三行稳妥可见。

需要我现在直接运行一次客户端帮你复测吗？你也可以手动执行：
- PowerShell（工作目录 `d:\\AI-Projects\\desktop_app`）
- `python .\\app_new.py`

我会根据你提供的具体 JSON 与日志信息，快速判断是“解析”还是“显示”，然后做针对性修正。
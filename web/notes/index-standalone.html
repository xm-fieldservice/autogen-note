<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PC ç¬”è®°é¡µé¢ï¼ˆä¸‰åº“é›†æˆï¼‰- å•é¡µç‰ˆ</title>
  <link rel="icon" href="data:," />
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft Yahei', sans-serif; color: #1f2937; }
    .app { display: grid; grid-template-columns: 300px 1fr 320px; grid-template-rows: 100vh; }
    .sidebar { border-right: 1px solid #e5e7eb; overflow: hidden; display: flex; flex-direction: column; }
    .tabs { display: flex; border-bottom: 1px solid #e5e7eb; }
    .tab { flex: 1; padding: 10px; border: 0; background: #f9fafb; cursor: pointer; }
    .tab.active { background: #fff; font-weight: 600; }
    .tab-content { padding: 10px; overflow: auto; height: calc(100vh - 42px); }
    .hidden { display: none; }

    .topic-list { list-style: none; padding: 0; margin: 0; }
    .topic-item { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; cursor: pointer; }
    .topic-title { width: 100%; border: none; background: transparent; font-size: 18px; font-weight: 600; cursor: text; }
    .topic-actions { display: flex; gap: 10px; }
    .icon-btn { border: none; background: transparent; cursor: pointer; width: 28px; height: 28px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
    .icon-btn.fav { color: #f59e0b; background: #fffbeb; }
    .icon-btn.export { color: #10b981; background: #ecfdf5; }
    .icon-btn.archive { color: #3b82f6; background: #eff6ff; }
    .icon-btn.delete { color: #ef4444; background: #fef2f2; }
    .topic-item.active { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
    .btn { background: #2563eb; color: #fff; border: 0; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .btn.add { background: #10b981; width: 100%; margin-top: 8px; }
    .btn.sm { padding: 4px 8px; font-size: 12px; }
    .btn.secondary { background: #6b7280; }

    .tags-panel { display: flex; flex-direction: column; gap: 8px; }
    .tags-header { display: flex; align-items: center; justify-content: space-between; }
    .tag-actions { display: flex; gap: 6px; }
    .tag-list { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 6px; }
    .tag-item { border: 1px solid #e5e7eb; border-radius: 16px; padding: 4px 10px; display: flex; gap: 6px; align-items: center; }

    .main { border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
    .mode-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #e5e7eb; }
    .modes { display: flex; align-items: center; gap: 8px; }
    .mode-btn { border: 0; padding: 6px 10px; border-radius: 6px; background: #f3f4f6; cursor: pointer; }
    .mode-btn.active { background: #dbeafe; color: #1d4ed8; font-weight: 600; }

    .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d1d5db; transition: .2s; border-radius: 9999px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 9999px; }
    input:checked + .slider { background-color: #2563eb; }
    input:checked + .slider:before { transform: translateX(16px); }
    .switch-label { margin-left: 6px; color: #6b7280; }

    .output, .input { display: flex; flex-direction: column; padding: 8px; }
    .output { height: 60%; border-bottom: 1px solid #e5e7eb; }
    .input { height: 40%; }
    .toolbar { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .spacer { flex: 1; }
    .editor { width: 100%; height: 100%; resize: none; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .feed { width: 100%; height: 100%; overflow: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; gap: 10px; background: #fff; }
    .feed-item { border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; background: #fafafa; }
    .feed-item .meta { font-size: 12px; color: #6b7280; margin-bottom: 6px; display: flex; justify-content: space-between; }
    .feed-item .content { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .agent-select, .recent-select { margin-left: 6px; padding: 3px 6px; border: 1px solid #e5e7eb; border-radius: 6px; }

    .sessions { overflow: auto; padding: 8px; }
    .sessions-header { border-bottom: 1px solid #e5e7eb; padding-bottom: 6px; margin-bottom: 6px; }
    .session-list { list-style: none; padding: 0; margin: 0; }
    .session-item { padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; cursor: pointer; }
    .session-item.active { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,0.15); }
    .session-actions { display: flex; gap: 6px; margin-top: 6px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:10px; font-size:12px; margin-left:6px; }
    .badge.ok { background:#ecfdf5; color:#059669; }
    .badge.fail { background:#fef2f2; color:#b91c1c; }
    .api-indicator small { color:#6b7280; margin-left:6px; }
    /* æ—¥å¿—åŒºæ ·å¼ */
    .log-section { border-top: 1px solid #e5e7eb; padding:8px; }
    .log-toolbar { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
    .log-feed { width:100%; height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px; background:#fff; display:flex; flex-direction:column; gap:6px; }
    .log-item { font-size:12px; line-height:1.4; border-left:3px solid #e5e7eb; padding:4px 6px; background:#fafafa; }
    .log-item.ok { border-color:#10b981; }
    .log-item.warn { border-color:#f59e0b; background:#fff7ed; }
    .log-item.err { border-color:#ef4444; background:#fef2f2; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="tabs">
        <button class="tab active" data-tab="current">å½“å‰è®®é¢˜</button>
        <button class="tab" data-tab="archived">å½’æ¡£è®®é¢˜</button>
        <button class="tab" data-tab="tags">æ ‡ç­¾</button>
      </div>
      <div class="tab-content" id="tab-current">
        <ul id="topic-list-current" class="topic-list"></ul>
        <button id="btn-add-topic" class="btn add">+ æ–°å¢è®®é¢˜</button>
      </div>
      <div class="tab-content hidden" id="tab-archived">
        <ul id="topic-list-archived" class="topic-list"></ul>
      </div>
      <div class="tab-content hidden" id="tab-tags">
        <div class="tags-panel">
          <div class="tags-header">
            <h4>æ ‡ç­¾ç®¡ç†</h4>
            <div class="tag-actions">
              <input id="input-new-tag" type="text" placeholder="æ–°æ ‡ç­¾å" />
              <button id="btn-add-tag" class="btn">æ–°å¢æ ‡ç­¾</button>
            </div>
          </div>
          <ul id="tag-list" class="tag-list"></ul>
          <div class="tag-hint">å¤šé€‰æ ‡ç­¾åï¼Œè®®é¢˜åˆ—è¡¨æŒ‰ AND è¿‡æ»¤ï¼›æ–°å»ºè®®é¢˜é»˜è®¤ç»§æ‰¿å·²é€‰æ ‡ç­¾ã€‚</div>
        </div>
      </div>
      <!-- è°ƒè¯•æ—¥å¿—åŒºï¼ˆå›ºå®šåœ¨ä¾§æ åº•éƒ¨ï¼‰ -->
      <div class="log-section">
        <div class="log-toolbar">
          <strong>è°ƒè¯•æ—¥å¿—</strong>
          <div class="spacer"></div>
          <button id="btn-copy-log" class="btn sm secondary">å¤åˆ¶</button>
          <button id="btn-clear-log" class="btn sm secondary">æ¸…ç©º</button>
        </div>
        <div id="debug-feed" class="log-feed" aria-label="è°ƒè¯•æ—¥å¿—"></div>
      </div>
    </aside>

    <main class="main">
      <div class="mode-bar">
        <div class="modes">
          <button class="mode-btn active" data-mode="note">ç¬”è®°</button>
          <button class="mode-btn" data-mode="search">æ£€ç´¢</button>
          <button class="mode-btn" data-mode="qa">é—®ç­”</button>
          <label class="switch">
            <input type="checkbox" id="auto-mode" />
            <span class="slider"></span>
          </label>
          <span class="switch-label">è‡ªåŠ¨æ¨¡å¼ï¼ˆé»˜è®¤å…³ï¼‰</span>
        </div>
        <div class="api-indicator">
          <span id="api-status" title="æœåŠ¡å™¨APIå¼€å…³">API: å¼€</span>
          <small id="api-base-label"></small>
        </div>
      </div>

      <section class="output">
        <div class="toolbar">
          <span>è¾“å‡º Markdownï¼ˆæ—¶é—´çº¿ï¼Œå¯æ»šåŠ¨ï¼‰</span>
          <div class="spacer"></div>
          <button class="btn sm" id="btn-output-bold">B</button>
          <button class="btn sm" id="btn-output-italic">I</button>
          <button class="btn sm" id="btn-output-copy">å¤åˆ¶å…¨éƒ¨</button>
          <!-- Team é€‰æ‹©å™¨ç§»åŠ¨è‡³æ­¤ï¼ˆå¤åˆ¶å…¨éƒ¨å³ä¾§ï¼‰ -->
          <div class="picker-group">
            <button id="btn-pick-team" class="btn sm">é€‰æ‹© Team</button>
            <select id="recent-teams" class="recent-select">
              <option value="">æœ€è¿‘ä½¿ç”¨â€¦</option>
            </select>
            <input type="file" id="team-file" accept=".json" class="hidden" />
          </div>
        </div>
        <div id="output-feed" class="feed" aria-label="è¾“å‡ºåŒºï¼ˆè¿ç»­æ—¶é—´çº¿ï¼Œæ”¯æŒæ»šåŠ¨æµè§ˆï¼‰"></div>
      </section>

      <section class="input">
        <div class="toolbar">
          <span>è¾“å…¥ Markdown</span>
          <div class="spacer"></div>
          <button class="btn sm" id="btn-input-bold">B</button>
          <button class="btn sm" id="btn-input-italic">I</button>
          <button class="btn sm" id="btn-input-copy">å¤åˆ¶å…¨éƒ¨</button>
          <button class="btn sm" id="btn-input-paste">ç²˜è´´</button>
          <button class="btn sm secondary" id="btn-test-shortcut" title="è¿›å…¥æˆ–é€€å‡ºå¿«æ·é”®è¯Šæ–­æ¨¡å¼">æµ‹è¯•å¿«æ·é”®</button>
          <button class="btn sm" id="btn-submit">æäº¤</button>
          <div class="picker-group">
            <button id="btn-pick-agent" class="btn sm">é€‰æ‹© Agent</button>
            <select id="recent-agents" class="recent-select" title="æœ€è¿‘ä½¿ç”¨çš„ Agent">
              <option value="">æœ€è¿‘ä½¿ç”¨â€¦</option>
            </select>
            <input type="file" id="agent-file" accept=".json" class="hidden" />
          </div>
        </div>
        <div class="toolbar" id="policy-bar" style="gap:12px;">
          <label><input type="checkbox" id="pol-index-vector"> å‘é‡å…¥é˜Ÿ</label>
          <label><input type="checkbox" id="pol-index-graphrag"> GraphRAG å…¥é˜Ÿ</label>
          <label>çŸ¥è¯†åº“
            <select id="pol-knowledge-base" class="recent-select">
              <option value="default">default</option>
              <option value="kb_project">kb_project</option>
              <option value="kb_law">kb_law</option>
            </select>
          </label>
          <label>TTL(å¤©)
            <input id="pol-ttl" type="number" min="0" step="1" style="width:80px;" />
          </label>
        </div>
        <textarea id="input-md" class="editor" placeholder="è¾“å…¥å†…å®¹ã€‚Enter=æ¢è¡Œï¼›ç‚¹å‡»â€œæäº¤â€ä¸€æ¬¡æ€§å®Œæˆï¼ˆè‹¥é€‰äº† Agent å°†å…ˆé¢„å¤„ç†ï¼‰"></textarea>
        <div class="input-actions">
          <label class="btn">
            é™„ä»¶ä¸Šä¼ 
            <input type="file" id="file-upload" class="hidden" multiple />
          </label>
        </div>
        <div class="hint">è¯´æ˜ï¼šç‚¹å‡»â€œæäº¤â€ä¸€æ¬¡æ€§å®Œæˆã€‚è‹¥å·²é€‰æ‹© Agentï¼Œå°†å…ˆè°ƒç”¨ Agent è¿›è¡Œé¢„å¤„ç†å¹¶å°†ç»“æœå†™å…¥è¾“å‡ºåŒºï¼ŒåŒæ—¶å†™å…¥å³ä¾§ä¼šè¯åˆ—è¡¨ï¼›æœªé€‰æ‹© Agent åˆ™ç›´æ¥å†™å…¥ã€‚</div>
      </section>
    </main>

    <aside class="sessions">
      <div class="sessions-header">
        <h4>ä¼šè¯è®°å½•</h4>
      </div>
      <ul id="session-list" class="session-list"></ul>
      <div style="padding:8px; border-top:1px solid #e5e7eb; display:flex; gap:8px;">
        <button id="btn-validate-session" class="btn sm" title="å¯¹é€‰ä¸­çš„ä¼šè¯è¿›è¡Œå…¥åº“æ ¡éªŒï¼ˆä¸è½åº“ï¼‰">æµ‹è¯•å…¥åº“</button>
      </div>
    </aside>
  </div>

  <script>
  (function(){
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    const uid = () => Math.random().toString(36).slice(2, 10);
    const escapeHTML = s => (s || '').replace(/[&<>"']/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;'}[c]));

    const state = {
        activeTab: 'current', activeMode: 'note', autoMode: false,
        selectedTeam: null, selectedAgent: null,
        recentTeams: [], recentAgents: [],
        selectedTags: new Set(),
        topics: { current: [], archived: [] },
        sessions: [],
        activeTopicId: null,
        selectedSessionId: null
    };

    // ç»Ÿä¸€æœåŠ¡æ¨¡å¼ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„è®¿é—®åç«¯ APIï¼ˆåŒæºåŒç«¯å£ï¼‰
    const apiBase = '';
    const apiBaseLabelVal = apiBase || (typeof location !== 'undefined' ? location.origin : '');
    try { localStorage.setItem('apiBaseOverride', apiBase); } catch {}

    function persist() {
        const feed = $('#output-feed');
        const feedData = Array.from(feed.querySelectorAll('.feed-item')).map(el => ({
            topicId: el.dataset.topicId || null,
            role: el.dataset.role || 'user',
            meta: el.querySelector('.meta')?.textContent || '',
            content: el.querySelector('.content')?.textContent || ''
        }));
        const data = {
            topics: state.topics, sessions: state.sessions,
            selectedTags: [...state.selectedTags], activeMode: state.activeMode,
            activeTab: state.activeTab, activeTopicId: state.activeTopicId,
            feed: feedData
        };
        localStorage.setItem('notes_ui_state_v1', JSON.stringify(data));
    }

    function collectPolicy() {
        const p = {
            index_vector: ($('#pol-index-vector').checked ? 1 : 0),
            index_graphrag: ($('#pol-index-graphrag').checked ? 1 : 0),
            knowledge_base: $('#pol-knowledge-base').value || null,
            retention_ttl_days: (() => { const v = $('#pol-ttl').value; return v ? parseInt(v, 10) : null; })()
        };
        try { localStorage.setItem('notes_policy_v1', JSON.stringify(p)); } catch {}
        return p;
    }

    function restorePolicy() {
        try {
            const raw = localStorage.getItem('notes_policy_v1'); if (!raw) return;
            const p = JSON.parse(raw);
            $('#pol-index-vector').checked = !!p.index_vector;
            $('#pol-index-graphrag').checked = !!p.index_graphrag;
            if (p.knowledge_base) $('#pol-knowledge-base').value = p.knowledge_base;
            if (p.retention_ttl_days != null) $('#pol-ttl').value = p.retention_ttl_days;
        } catch {}
    }
    window.persistUI = persist;

    function load() {
        try { const raw = localStorage.getItem('notes_ui_state_v1'); if (!raw) return null; return JSON.parse(raw); } catch { return null }
    }

    const RECENT_TEAMS_KEY = 'notes_recent_teams_v1';
    const RECENT_AGENTS_KEY = 'notes_recent_agents_v1';
    function loadRecent(key) { try { return JSON.parse(localStorage.getItem(key) || '[]') } catch { return [] } }
    function saveRecent(key, path, name) { const list = loadRecent(key); if (!list.find(x => x.path === path)) { list.unshift({ path, name, ts: Date.now() }); localStorage.setItem(key, JSON.stringify(list.slice(0, 10))); } }
    function renderRecentSelect(selId, key) { const list = loadRecent(key); const sel = $(selId); sel.innerHTML = '<option value="">æœ€è¿‘ä½¿ç”¨â€¦</option>' + list.map(rt => `<option value="${encodeURIComponent(rt.path)}">${rt.name}</option>`).join(''); }

    function bindTabs() {
        $$('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                $$('.tab').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                state.activeTab=btn.dataset.tab;
                $$('.tab-content').forEach(c=>c.classList.add('hidden'));
                $(`#tab-${state.activeTab}`).classList.remove('hidden');
                persist();
            });
        });
    }

    // topics
    function topicItemHTML(t){
      const favIcon = t.favorited ? 'â˜…' : 'â˜†';
      const delDisabled = t.favorited ? 'disabled' : '';
      return `<li class="topic-item" data-id="${t.id}">
        <input class="topic-title" value="${escapeHTML(t.title)}" />
        <div class="topic-actions">
          <button type="button" class="icon-btn fav" data-act="fav" title="æ”¶è—">${favIcon}</button>
          <button type="button" class="icon-btn export" data-act="export" title="å¯¼å‡º">â¤“</button>
          <button type="button" class="icon-btn archive" data-act="archive" title="å½’æ¡£">ğŸ—‚ï¸</button>
          <button type="button" class="icon-btn delete" data-act="del" title="åˆ é™¤" ${delDisabled}>ğŸ—‘ï¸</button>
        </div>
      </li>`;
    }
    function renderTopics(){
      const lists={ current:$('#topic-list-current'), archived:$('#topic-list-archived') };
      Object.entries(lists).forEach(([key,ul])=>{
        const set=state.topics[key]||[]; const selected=[...state.selectedTags];
        const filtered= selected.length? set.filter(t=> selected.every(tag=> (t.tags||[]).includes(tag))): set;
        ul.innerHTML=filtered.map(t=>topicItemHTML(t)).join('');
      });
      // bind items
      $$('#topic-list-current .topic-item, #topic-list-archived .topic-item').forEach(item=>bindTopicItem(item));
    }
    function bindTopicItem(el){
      const id=el.dataset.id; const input=$('.topic-title',el);
      el.addEventListener('click',e=>{ if(e.target.closest('.topic-actions')) return; setActiveTopic(id); locateToTopic(id); });
      input.addEventListener('click',()=>{ setActiveTopic(id); locateToTopic(id); });
      input.addEventListener('dblclick',()=> input.removeAttribute('readonly'));
      input.addEventListener('blur',()=>{ const t=findTopicById(id); if(t){ t.title=(input.value||'').trim()||t.title; persist(); }});
      const act=n=>$('.topic-actions [data-act="'+n+'"]',el);
      act('fav').addEventListener('click',e=>{e.stopPropagation(); toggleFav(id); persist();});
      act('export').addEventListener('click',e=>{e.stopPropagation(); exportTopic(id);});
      act('archive').addEventListener('click',e=>{e.stopPropagation(); toggleArchive(id); persist();});
      act('del').addEventListener('click',e=>{e.stopPropagation(); deleteTopic(id); persist();});
    }
    function findTopicById(id){ return state.topics.current.find(t=>t.id===id) || state.topics.archived.find(t=>t.id===id); }
    function setActiveTopic(id){
      state.activeTopicId=id;
      document.querySelectorAll('.topic-item').forEach(el=> el.classList.toggle('active', el.dataset.id===id));
      // åŒæ­¥åˆ·æ–°å³ä¾§ä¼šè¯åˆ—è¡¨
      renderSessions();
      // åŒæ­¥è¿‡æ»¤ä¸­é—´æ è¾“å‡ºæ—¶é—´çº¿
      filterFeedByActiveTopic();
      persist();
    }
    function locateToTopic(id){ // è¾“å‡ºæ—¶é—´çº¿å®šä½åˆ°è¯¥è®®é¢˜çš„æœ€åä¸€æ¡
      const feed=$('#output-feed'); const items=Array.from(feed.querySelectorAll('.feed-item')).filter(x=>x.dataset.topicId===String(id));
      if(items.length){ items[items.length-1].scrollIntoView({behavior:'smooth', block:'center'}); }
      // å³æ å®šä½åˆ°è¯¥è®®é¢˜æœ€æ–°ä¼šè¯
      const sessions=Array.from($('#session-list').querySelectorAll('.session-item')).filter(x=>x.dataset.topicId===String(id));
      if(sessions.length){ sessions[0].scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }

    // æ ¹æ®å½“å‰é€‰ä¸­è®®é¢˜è¿‡æ»¤ä¸­é—´æ çš„è¾“å‡ºæ—¶é—´çº¿
    function filterFeedByActiveTopic(){
      const activeId = state.activeTopicId ? String(state.activeTopicId) : null;
      const items = $$('#output-feed .feed-item');
      items.forEach(el=>{
        if(!activeId){ el.style.display=''; return; }
        const tid = el.dataset.topicId || '';
        el.style.display = (String(tid)===activeId) ? '' : 'none';
      });
    }
    function toggleFav(id){ const t=findTopicById(id); if(!t) return; t.favorited=!t.favorited; renderTopics(); }
    function toggleArchive(id){ let from=state.topics.current, to=state.topics.archived; let t=from.find(x=>x.id===id); if(!t){ from=state.topics.archived; to=state.topics.current; t=from.find(x=>x.id===id); }
      if(!t||t.favorited) return; from.splice(from.indexOf(t),1); t.archived=!t.archived; to.unshift(t); renderTopics(); }
    function deleteTopic(id){ const t=findTopicById(id); if(!t||t.favorited) return; if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è®®é¢˜åŠå…¶æ‰€æœ‰ä¼šè¯ä¸è¾“å‡ºå†…å®¹ï¼Ÿ')) return;
      state.topics.current=state.topics.current.filter(x=>x.id!==id); state.topics.archived=state.topics.archived.filter(x=>x.id!==id);
      state.sessions=state.sessions.filter(s=>s.topicId!==id);
      const feed=$('#output-feed'); Array.from(feed.querySelectorAll('.feed-item')).forEach(item=>{ if(item.dataset.topicId===String(id)) item.remove(); });
      if(state.activeTopicId===id) state.activeTopicId=null; renderTopics(); renderSessions(); }

    // export: topic -> markdown + attachments.json (åˆ›å»ºæ—¶é—´å‡åº)
    async function exportTopic(topicId){
      if(apiEnabled){ try{ const res = await fetch(`/export/topic/${encodeURIComponent(topicId)}`); const data = await res.json(); downloadText(`topic-${topicId}.md`, data.markdown||'', 'text/markdown;charset=utf-8'); downloadText('attachments.json', JSON.stringify(data.attachments||[], null, 2), 'application/json;charset=utf-8'); return; } catch(err){ console.warn('[export api] å¤±è´¥ï¼Œæ”¹ç”¨æœ¬åœ°å¯¼å‡º', err); } }
      const t = findTopicById(topicId); if(!t){ alert('æœªæ‰¾åˆ°è¯¥è®®é¢˜'); return; }
      const notes = state.sessions.filter(s=> s.topicId===topicId).slice().sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
      const lines = [];
      lines.push(`# è®®é¢˜ï¼š${t.title}`);
      lines.push('');
      notes.forEach((n, idx)=>{ const ts = new Date(n.createdAt||Date.now()).toLocaleString(); lines.push(`## ç¬”è®° ${idx+1}`); lines.push(`> åˆ›å»ºæ—¶é—´ï¼š${ts}`); lines.push(''); lines.push(n.content||''); lines.push(''); });
      downloadText(`topic-${topicId}.md`, lines.join('\n'), 'text/markdown;charset=utf-8');
      downloadText('attachments.json', JSON.stringify([], null, 2), 'application/json;charset=utf-8');
    }

    function downloadText(filename, content, mime){
      const blob = new Blob([content], {type: mime||'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    $('#btn-add-topic').addEventListener('click',()=>{ const id=uid(); const tags=[...state.selectedTags]; state.topics.current.unshift({id, title:`æ–°è®®é¢˜_${id}`, tags, favorited:false, archived:false}); renderTopics(); setActiveTopic(id); persist(); });

    // tags
    const tagSet=new Set();
    function renderTags(){ const ul=$('#tag-list'); const all=[...tagSet]; ul.innerHTML= all.map(tag=>`<li class="tag-item"><label><input type="checkbox" data-tag="${tag}" ${state.selectedTags.has(tag)?'checked':''}/> ${tag}</label><button class="btn sm secondary" data-del="${tag}">åˆ </button></li>`).join('');
      $$('#tag-list input[type="checkbox"]').forEach(cb=> cb.addEventListener('change',()=>{ const tag=cb.dataset.tag; if(cb.checked) state.selectedTags.add(tag); else state.selectedTags.delete(tag); renderTopics(); persist(); }));
      $$('#tag-list [data-del]').forEach(btn=> btn.addEventListener('click',()=>{ tagSet.delete(btn.dataset.del); state.selectedTags.delete(btn.dataset.del); renderTags(); renderTopics(); persist(); }));
    }
    $('#btn-add-tag').addEventListener('click',()=>{ const name=$('#input-new-tag').value.trim(); if(!name) return; tagSet.add(name); $('#input-new-tag').value=''; renderTags(); persist(); });

    // modes
    $$('.mode-btn').forEach(btn=> btn.addEventListener('click',()=>{ $$('.mode-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); state.activeMode=btn.dataset.mode; persist(); }));
    $('#auto-mode').addEventListener('change',e=>{ state.autoMode=!!e.target.checked; persist(); });

    // team & agent pickers
    $('#btn-pick-team').addEventListener('click',()=>$('#team-file').click());
    $('#team-file').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; state.selectedTeam={name:f.name,path:f.name}; saveRecent(RECENT_TEAMS_KEY,f.name,f.name); renderRecentSelect('#recent-teams',RECENT_TEAMS_KEY); });
    $('#recent-teams').addEventListener('change',e=>{ const v=e.target.value; if(!v) return; const path=decodeURIComponent(v); const item=loadRecent(RECENT_TEAMS_KEY).find(x=>x.path===path); if(item) state.selectedTeam={name:item.name,path:item.path}; });

    $('#btn-pick-agent').addEventListener('click',()=>$('#agent-file').click());
    $('#agent-file').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; state.selectedAgent={name:f.name,path:f.name}; saveRecent(RECENT_AGENTS_KEY,f.name,f.name); renderRecentSelect('#recent-agents',RECENT_AGENTS_KEY);
      // å¼ºåˆ¶å¼€å¯å¹¶é”å®š API
      apiPinned = true; apiEnabled = true; const st=$('#api-status'); if(st) st.textContent='API: å¼€*'; const lbl=$('#api-base-label'); if(lbl) lbl.textContent=apiBaseLabelVal; console.log('[api] pinned ON due to agent selection'); });
    $('#recent-agents').addEventListener('change',e=>{ const v=e.target.value; if(!v) return; const path=decodeURIComponent(v); const item=loadRecent(RECENT_AGENTS_KEY).find(x=>x.path===path); if(item) state.selectedAgent={name:item.name,path:item.path};
      // å¼ºåˆ¶å¼€å¯å¹¶é”å®š APIï¼ˆé€‰æ‹©æœ€è¿‘ Agent æ—¶ï¼‰
      apiPinned = true; apiEnabled = true; const st=$('#api-status'); if(st) st.textContent='API: å¼€*'; const lbl=$('#api-base-label'); if(lbl) lbl.textContent=apiBaseLabelVal; console.log('[api] pinned ON due to recent agent selection'); });

    // editors & shortcuts
    function wrap(textarea, wrapper){ const s=textarea.selectionStart, e=textarea.selectionEnd, v=textarea.value; textarea.value = v.slice(0,s)+wrapper+v.slice(s,e)+wrapper+v.slice(e); textarea.focus(); }
    $('#btn-input-bold').addEventListener('click',()=> wrap($('#input-md'),'**'));
    $('#btn-input-italic').addEventListener('click',()=> wrap($('#input-md'),'*'));
    $('#btn-input-copy').addEventListener('click',()=> navigator.clipboard.writeText($('#input-md').value));
    $('#btn-input-paste').addEventListener('click', async()=> { const t=await navigator.clipboard.readText(); $('#input-md').value += t; });

    $('#btn-output-bold').addEventListener('click',()=> wrapLastFeed('**'));
    $('#btn-output-italic').addEventListener('click',()=> wrapLastFeed('*'));
    $('#btn-output-copy').addEventListener('click',()=> { const texts=[...$('#output-feed').querySelectorAll('.feed-item .content')].map(n=>n.textContent||''); navigator.clipboard.writeText(texts.join('\n\n')); });

    $('#file-upload').addEventListener('change',async e=>{ const files=[...(e.target.files||[])]; if(!files.length) return; if(!apiEnabled){ console.log('[upload] æœ¬åœ°æ¨¡å¼å ä½', files.map(f=>({name:f.name,size:f.size}))); return; } for(const f of files){ try{ const fd=new FormData(); fd.append('topic_id', state.activeTopicId||''); fd.append('file', f, f.name); const res= await fetch(`/ingest`, { method:'POST', body: fd }); const data = await res.json(); console.log('[ingest] ok', data); } catch(err){ console.error('[ingest] å¤±è´¥', err); } } });

    function appendFeedItem({role,content,agent,topicId}){
      const feed=$('#output-feed'); const time=new Date().toLocaleString();
      const div=document.createElement('div'); div.className='feed-item';
      div.dataset.role=role||'user'; if(topicId) div.dataset.topicId=String(topicId);
      div.innerHTML=`<div class="meta"><span>${role==='user'?'è¾“å…¥/é¢„å¤„ç†':'è¾“å‡º/ç»“æœ'} Â· ${agent||''}</span><span>${time}</span></div><div class="content"></div>`;
      div.querySelector('.content').textContent=content;
      // åˆæ­¥æŒ‰å½“å‰è®®é¢˜å†³å®šæ˜¯å¦å¯è§
      const activeId = state.activeTopicId ? String(state.activeTopicId) : null;
      if(activeId){ const tid = div.dataset.topicId || ''; div.style.display = (String(tid)===activeId)? '' : 'none'; }
      feed.appendChild(div);
      // ç»Ÿä¸€å†æ‰§è¡Œä¸€æ¬¡è¿‡æ»¤ï¼Œç¡®ä¿å…¶ä»–æ¡ç›®çŠ¶æ€æ­£ç¡®
      filterFeedByActiveTopic();
      // å®šä½åˆ°åº•éƒ¨/å¯è§åŒºåŸŸ
      feed.scrollTop=feed.scrollHeight;
      persist();
    }
    // ç‹¬ç«‹æ—¥å¿—è¿½åŠ ï¼ˆä¸å—è®®é¢˜è¿‡æ»¤å½±å“ï¼‰
    function appendLogItem({level, content}){
      const box = $('#debug-feed'); const time=new Date().toLocaleTimeString();
      const div=document.createElement('div');
      const lvl = (level||'log').toLowerCase();
      div.className = 'log-item ' + (lvl==='error'?'err': (lvl==='warn'?'warn':'ok'));
      div.textContent = `[${time}] ${content}`;
      box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
    function wrapLastFeed(wrapper){ const items=$$('#output-feed .feed-item .content'); if(!items.length) return; const last=items[items.length-1]; last.textContent = `${wrapper}${last.textContent}${wrapper}`; persist(); }
    function latestFeedText(){ const items=$$('#output-feed .feed-item .content'); if(!items.length) return ''; return items[items.length-1].textContent||''; }

    async function preprocess(){
      const text=$('#input-md').value;
      const agentSelected = !!(state.selectedAgent && state.selectedAgent.path);
      const agent=state.selectedAgent?.name||'default';
      // æƒ…å†µ1ï¼šæœªé€‰æ‹©Agent â†’ ç›´æ¥åŸæ ·è¾“å‡º
      if(!agentSelected){ appendFeedItem({role:'user', content:text, agent:'(æ— Agent)', topicId: state.activeTopicId}); $('#input-md').value=''; return; }
      // æƒ…å†µ2ï¼šé€‰æ‹©äº†Agent â†’ èµ°APIï¼ˆè‹¥APIä¸å¯ç”¨åˆ™å›é€€åŸæ ·è¾“å‡ºï¼‰
      if(apiEnabled){
        try{
          console.log('[preprocess] start via API', { topic_id: state.activeTopicId, mode: state.activeMode, agent: state.selectedAgent?.path });
          const res = await fetch(`/preprocess`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topic_id: state.activeTopicId, raw_md: text, mode: state.activeMode, agent_config_path: state.selectedAgent?.path||null }) });
          const data = await res.json();
          console.log('[preprocess] done', { ok: data?.ok, len: (data?.markdown||'').length });
          appendFeedItem({role:'user', content:data.markdown||text, agent, topicId: state.activeTopicId});
        }catch(err){ console.warn(`[preprocess api] å¤±è´¥ï¼Œå›é€€æœ¬åœ°. Error: ${err.message || String(err)}`); appendFeedItem({role:'user', content:text, agent, topicId: state.activeTopicId}); }
      } else {
        appendFeedItem({role:'user', content:text, agent, topicId: state.activeTopicId});
      }
      $('#input-md').value='';
    }
    async function oneShotSubmit(){
      if(!state.activeTopicId){ alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®®é¢˜'); return; }
      await preprocess();
      const content=latestFeedText(); const topicId=state.activeTopicId; if(!topicId){ return; }
      if(state.activeMode==='note' || state.activeMode==='search'){
        const sid=uid(); state.sessions.unshift({id:sid, topicId, content, createdAt: Date.now(), favorited:false, dbStatus:'local'}); renderSessions();
      } else if(state.activeMode==='qa'){
        const sid=uid(); const answer=content+"\n\n> [å ä½æŸ¥è¯¢ç»“æœ]"; appendFeedItem({role:'assistant', content:answer, agent: state.selectedTeam?.name||'team', topicId}); state.sessions.unshift({id:sid, topicId, content:answer, createdAt: Date.now(), favorited:false, dbStatus:'local'}); renderSessions();
      }
      persist();
    }

    // å¿«æ·é”®è¯Šæ–­
    let isShortcutTesting = false;
    const btnTestShortcut = document.getElementById('btn-test-shortcut');
    function shortcutTestListener(e) {
      e.preventDefault();
      const msg = `[Shortcut Test] key: ${e.key}, code: ${e.code}, alt: ${e.altKey}, ctrl: ${e.ctrlKey}, shift: ${e.shiftKey}, meta: ${e.metaKey}`;
      console.log(msg);
    }
    btnTestShortcut?.addEventListener('click', () => {
      isShortcutTesting = !isShortcutTesting;
      if (isShortcutTesting) {
        console.log('[shortcut] è¿›å…¥è¯Šæ–­æ¨¡å¼');
        document.addEventListener('keydown', shortcutTestListener, true);
        btnTestShortcut.style.backgroundColor = '#ef4444'; // çº¢è‰²è¡¨ç¤ºæ¿€æ´»
        btnTestShortcut.textContent = 'åœæ­¢æµ‹è¯•';
      } else {
        console.log('[shortcut] é€€å‡ºè¯Šæ–­æ¨¡å¼');
        document.removeEventListener('keydown', shortcutTestListener, true);
        btnTestShortcut.style.backgroundColor = ''; // æ¢å¤åŸæ ·
        btnTestShortcut.textContent = 'æµ‹è¯•å¿«æ·é”®';
      }
    });

    document.getElementById('btn-submit')?.addEventListener('click', oneShotSubmit);

    // ç»Ÿä¸€å¤„ç†æäº¤å¿«æ·é”®ï¼ˆAlt+Enter æˆ– Ctrl+Enterï¼‰
    function handleGlobalSubmitShortcut(e) {
      // å¢åŠ è°ƒè¯•æ—¥å¿—ï¼ŒæŠ•å°„åˆ°è¾“å‡ºåŒºï¼Œä¾¿äºåˆ¤æ–­äº‹ä»¶æ˜¯å¦è¢«æ•è·
      console.log(`[shortcut] keydown: key=${e.key} alt=${e.altKey} ctrl=${e.ctrlKey}`);
      const isSubmit = e.key === 'Enter' && (e.altKey || e.ctrlKey);
      if (isSubmit) {
        console.log('[shortcut] å¿«æ·é”®æäº¤è§¦å‘');
        e.preventDefault();
        oneShotSubmit();
      }
    }
    // å…¨å±€ç»‘å®šå¿«æ·é”®ï¼Œç¡®ä¿ä»»ä½•æ—¶å€™éƒ½èƒ½è§¦å‘
    document.addEventListener('keydown', handleGlobalSubmitShortcut);

    function renderSessions(){
      const ul=$('#session-list');
      const activeId = state.activeTopicId;
      const list = activeId ? state.sessions.filter(s=> String(s.topicId)===String(activeId)) : state.sessions;
      ul.innerHTML = list.map(s=>{
        const delDisabled = s.favorited ? 'disabled' : '';
        const favIcon = s.favorited ? 'â˜…' : 'â˜†';
        const status = (s.dbStatus==='done')? '<span class="badge ok" title="å·²å†™å…¥åç«¯">å·²å…¥åº“</span>' : (s.dbStatus? '<span class="badge fail" title="æœªå†™å…¥åç«¯">æœªå…¥åº“</span>':'' );
        const meta = s.noteId? ` <small title="note_id">#${s.noteId.slice(0,8)}</small>`: '';
        return `<li class="session-item" data-id="${s.id}" data-topic-id="${s.topicId}"><div class="session-content">${escapeHTML((s.content||'').slice(0,200))}${status}${meta}</div><div class="session-actions"><button class="icon-btn fav" data-act="fav" title="æ”¶è—">${favIcon}</button><button class="icon-btn copy" data-act="copy" title="å¤åˆ¶">ğŸ“‹</button><button class="btn sm" data-act="store" title="å…¥åº“">å…¥åº“</button><button class="icon-btn delete" data-act="del" title="åˆ é™¤" ${delDisabled}>ğŸ—‘ï¸</button></div></li>`;
      }).join('');
      $$('#session-list .session-item').forEach(item=>{ const id=item.dataset.id; const find=()=> state.sessions.find(x=>x.id===id);
        $('[data-act="fav"]',item).addEventListener('click',()=>{ const s=find(); if(s){ s.favorited=!s.favorited; renderSessions(); persist(); }});
        $('[data-act="copy"]',item).addEventListener('click',()=>{ const s=find(); if(s) navigator.clipboard.writeText(s.content); });
        $('[data-act="store"]',item).addEventListener('click', async()=>{ const s=find(); if(!s){ return; } if(s.dbStatus==='done' && s.noteId){ alert('è¯¥ä¼šè¯å·²å…¥åº“'); return; } const payload={ topic_id:String(s.topicId), final_md:s.content, mode: state.activeMode, team_config_path: state.selectedTeam?.path||null, policy: collectPolicy() }; try{ const res= await fetch(`${apiBase}/notes/store`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); const data = await res.json(); if(data && data.note_id){ s.dbStatus = data.db_status || 'done'; s.noteId = data.note_id; renderSessions(); appendFeedItem({ role:'assistant', content:`å…¥åº“å®Œæˆï¼š#${String(data.note_id).slice(0,8)}`, agent:'store', topicId: state.activeTopicId }); } else { alert('å…¥åº“è¿”å›æ—  note_id'); } } catch(err){ alert('å…¥åº“å¤±è´¥ï¼š'+ String(err)); }
        });
        $('[data-act="del"]',item).addEventListener('click',()=>{ const s=find(); if(!s) return; if(s.favorited){ alert('è¯¥ä¼šè¯å·²æ”¶è—ï¼Œä¸èƒ½åˆ é™¤'); return; } if(!confirm('ç¡®è®¤åˆ é™¤è¯¥ä¼šè¯å—åŠå…¶åœ¨è¾“å‡ºåŒºçš„å¯¹åº”å†…å®¹ï¼Ÿ')) return; state.sessions = state.sessions.filter(x=>x.id!==id); renderSessions(); const feed=$('#output-feed'); const contents=[...feed.querySelectorAll('.feed-item .content')].map(n=>n.textContent||''); const idx=contents.lastIndexOf(s.content||''); if(idx>=0){ feed.querySelectorAll('.feed-item')[idx]?.remove(); } persist(); });
        // ç‚¹å‡»é€‰æ‹©ä¼šè¯
        item.addEventListener('click',e=>{ if(e.target.closest('.session-actions')) return; document.querySelectorAll('.session-item').forEach(el=> el.classList.remove('active')); item.classList.add('active'); state.selectedSessionId = id; const s=find(); if(!s) return; const feed=$('#output-feed'); const items=[...feed.querySelectorAll('.feed-item')]; const pos=items.findIndex(n=> (n.querySelector('.content')?.textContent||'') === (s.content||'')); if(pos>=0) items[pos].scrollIntoView({behavior:'smooth', block:'center'}); });
      });
    }

    // ç»Ÿä¸€â€œæµ‹è¯•å…¥åº“â€æŒ‰é’®é€»è¾‘
    async function validateSelectedSession() {
      const id = state.selectedSessionId;
      if (!id) { alert('è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€æ¡ä¼šè¯'); return; }
      const s = state.sessions.find(x => x.id === id);
      if (!s) { alert('æœªæ‰¾åˆ°è¯¥ä¼šè¯'); return; }
      if (!s.noteId) { alert('è¯¥ä¼šè¯ç¼ºå°‘ note_idï¼Œå¯èƒ½æ˜¯æœ¬åœ°æ¨¡å¼æˆ–æ—§æ•°æ®ï¼Œæ— æ³•æµ‹è¯•å…¥åº“'); return; }
      try {
        const payload = { topic_id: String(s.topicId), note_id: String(s.noteId), expect: (s.content || '').slice(0, 200), api_base: apiBase };
        const res = await fetch(`${apiBase}/test/validate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        const ok = !!(data && (data.ok === true || data.ok === 'true'));
        let report = (data && data.report_markdown) ? String(data.report_markdown) : '';
        if (!report || !report.trim()) {
          try { report = 'è¿”å›æ•°æ®ï¼š\n\n```json\n' + JSON.stringify(data, null, 2) + '\n```'; } catch { report = 'ï¼ˆæ— æŠ¥å‘Šï¼‰'; }
        }
        const finalMd = (ok ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•æœªé€šè¿‡') + '\n\n' + report;
        appendFeedItem({ role: 'assistant', content: finalMd, agent: 'validator', topicId: state.activeTopicId });
        const sid = uid();
        state.sessions.unshift({ id: sid, topicId: state.activeTopicId, content: finalMd, createdAt: Date.now(), favorited: false, dbStatus: 'local' });
        renderSessions();
        persist();
        appendDebug(`[æµ‹è¯•å…¥åº“] ${ok ? 'æˆåŠŸ' : 'å¤±è´¥'}`, ok ? 'log' : 'error');
      } catch (err) {
        appendDebug(`[æµ‹è¯•å…¥åº“] å¤±è´¥: ${err}`, 'error');
      }
    }

    // ========== è°ƒè¯•ä¿¡æ¯æŠ•å°„åˆ°ä¾§æ æ—¥å¿—åŒº ==========
    function appendDebug(msg, level = 'log'){
      try {
        const content = `[${String(level).toUpperCase()}] ${String(msg)}`;
        appendLogItem({ level, content });
      } catch(e) {
        (console._original_error || console.error)('Error in appendDebug:', e);
      }
    }
    (function hookConsole(){
      const olog = console.log, owarn = console.warn, oerr = console.error;
      console._original_log = olog; console._original_warn = owarn; console._original_error = oerr;
      console.log = (...args)=>{ olog.apply(console, args); try{ appendDebug(args.map(x=> (typeof x==='string'? x: JSON.stringify(x, null, 2))).join(' '), 'log'); }catch{} };
      console.warn = (...args)=>{ owarn.apply(console, args); try{ appendDebug(args.map(x=> (typeof x==='string'? x: JSON.stringify(x, null, 2))).join(' '), 'warn'); }catch{} };
      console.error = (...args)=>{ oerr.apply(console, args); try{ appendDebug(args.map(x=> (typeof x==='string'? x: JSON.stringify(x, null, 2))).join(' '), 'error'); }catch{} };
    })();

    // æ—¥å¿—åŒºï¼šæ¸…ç©ºä¸å¤åˆ¶
    document.getElementById('btn-clear-log')?.addEventListener('click',()=>{ const box=$('#debug-feed'); if(box) box.innerHTML=''; });
    document.getElementById('btn-copy-log')?.addEventListener('click',()=>{ const box=$('#debug-feed'); if(box) navigator.clipboard.writeText(box.innerText); });

    // å½“é€‰æ‹© Agent åï¼Œå¼ºåˆ¶é”å®š API å¤„äºå¼€å¯çŠ¶æ€ï¼Œå¥åº·æ£€æŸ¥ä¸å†å°†å…¶ç½®ä¸ºâ€œå…³â€
    let apiPinned = false;
    document.getElementById('api-status').textContent = 'API: å¼€';
    document.getElementById('api-base-label').textContent = apiBaseLabelVal;

    function init(){
      // load saved or demo
      const saved=load();
      if(saved){ state.topics=saved.topics||state.topics; state.sessions=saved.sessions||state.sessions; state.selectedTags=new Set(saved.selectedTags||[]); state.activeMode=saved.activeMode||state.activeMode; state.activeTab=saved.activeTab||'current'; state.activeTopicId=saved.activeTopicId||null; setTimeout(()=>{ const feed=$('#output-feed'); (saved.feed||[]).forEach(it=> appendFeedItem({role:it.role, content:it.content, agent:'', topicId: it.topicId})); },0); }
      else { state.topics.current=[ {id:uid(), title:'é¡¹ç›®å‘¨æŠ¥', tags:['éœ€æ±‚','å†…éƒ¨'], favorited:false, archived:false}, {id:uid(), title:'æ³•è§„ç ”è¯»', tags:['æ³•è§„'], favorited:true, archived:false} ]; }

      // tabs
      $$('.tab').forEach(b=> b.classList.toggle('active', b.dataset.tab===state.activeTab));
      $$('.tab-content').forEach(c=> c.classList.toggle('hidden', c.id !== `tab-${state.activeTab}`));

      // demo tags
      ;['éœ€æ±‚','è§„åˆ’','æ³•è§„','å†…éƒ¨'].forEach(t=> tagSet.add(t));

      // renders
      renderRecentSelect('#recent-teams', RECENT_TEAMS_KEY);
      renderRecentSelect('#recent-agents', RECENT_AGENTS_KEY);
      renderTags(); renderTopics(); renderSessions();
      if(state.activeTopicId){ setActiveTopic(state.activeTopicId); locateToTopic(state.activeTopicId); }
      // æ¢å¤ç­–ç•¥
      restorePolicy();

      bindTabs();
      // ç®€å•å¥åº·æ£€æŸ¥ + è½®è¯¢
      let lastApiOk = null;
      function updateApiIndicator(ok){
        if (apiPinned){
          apiEnabled = true;
          document.getElementById('api-status').textContent = 'API: å¼€*';
          document.getElementById('api-base-label').textContent = apiBaseLabelVal;
          if (lastApiOk !== true){ appendDebug('[api] pinned å¼€å¯ï¼ˆå¿½ç•¥å¥åº·æ£€æŸ¥ç»“æœï¼‰'); }
          lastApiOk = true;
          return;
        }
        apiEnabled = !!ok;
        document.getElementById('api-status').textContent = ok? 'API: å¼€' : 'API: å…³';
        document.getElementById('api-base-label').textContent = apiBaseLabelVal;
        if (lastApiOk !== ok){ appendDebug(`[api] å¥åº·æ£€æŸ¥ï¼š${ok? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`); lastApiOk = ok; }
      }
      async function checkHealth(){ try{ const res = await fetch(`/healthz`, { cache:'no-store' }); updateApiIndicator(res.ok); } catch{ updateApiIndicator(false); } }
      checkHealth();
      setInterval(checkHealth, 10000);
      // åˆæ¬¡è¿›å…¥æ—¶ï¼Œæ ¹æ®å·²é€‰è®®é¢˜è¿‡æ»¤ä¸­é—´æ 
      filterFeedByActiveTopic();
      // ç»‘å®šç»Ÿä¸€â€œæµ‹è¯•å…¥åº“â€æŒ‰é’®
      const btnValidate = document.getElementById('btn-validate-session');
      if(btnValidate){ btnValidate.addEventListener('click', validateSelectedSession); }
    }

    init();
  })();
  </script>
</body>
</html>
